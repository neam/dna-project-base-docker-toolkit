
# workaround for default action
neam: build-neam

build-neam: neam.debian-php neam.util neam.php-app-images neam.stack-images neam.dna-project-base

neam.debian-php:
	echo "Building debian-php images"
	docker build -t neam/debian-php:fpm-5.6.20-hhvm-3.13.1         images/neam/debian-php/php-fpm-hhvm
	docker build --build-arg PHP_PACKAGE_NAME_VERSION=7.0 --build-arg PHP_VERSION=7.0.7 -t neam/debian-php:fpm-7.0.7-hhvm-3.13.1         images/neam/debian-php/php-fpm-hhvm

neam.util:
	echo "Building api-mock image"
	docker build -t neam/api-mock   images/neam/api-mock

neam.php-app-images: export version=0.7.0
neam.php-app-images: neam.debian-php
	echo "Building neam.php-app-images images"
	docker build -t neam/php-app-builder:$(version)  images/neam/php-app-builder
	docker build -t neam/php-app-worker:$(version)   images/neam/php-app-worker
	docker build --build-arg PHP_PACKAGE_NAME_VERSION=7.0 -t neam/php-app-builder:$(version)-php7.0  images/neam/php-app-builder
	docker build --build-arg PHP_PACKAGE_NAME_VERSION=7.0 -t neam/php-app-worker:$(version)-php7.0   images/neam/php-app-worker

neam.stack-images:
	echo "Building debian-php-nginx stack base php image"
	docker build -t neam/debian-php:fpm-5.6.20-hhvm-3.13.1-for-debian-php-nginx-stack  stacks/neam/debian-php-nginx/stack/php/images
	docker build --build-arg PHP_PACKAGE_NAME_VERSION=7.0 -t neam/debian-php:fpm-7.0.7-hhvm-3.13.1-for-debian-php-nginx-stack  stacks/neam/debian-php-nginx/stack/php/images/php7.0

neam.dna-project-base: export version=0.7.0
neam.dna-project-base: neam.php-app-images neam.stack-images
	echo "Building neam.dna-project-base stack base php image"
	docker build -t neam/dna-project-base-debian-php:$(version)  stacks/neam/debian-php-nginx.dna-project-base/stack/php/images/dna-project-base-debian-php
	docker build -t neam/dna-project-base-debian-php:$(version)-php7.0  stacks/neam/debian-php-nginx.dna-project-base/stack/php/images//dna-project-base-debian-php/php7.0
	echo "Building neam.dna-project-base stack base php tester image"
	docker build -t neam/dna-project-base-debian-php-tester:$(version)  stacks/neam/debian-php-nginx.dna-project-base/stack/php/images/dna-project-base-debian-php/tester
	docker build -t neam/dna-project-base-debian-php-tester:$(version)-php7.0  stacks/neam/debian-php-nginx.dna-project-base/stack/php/images/dna-project-base-debian-php/tester/php7.0

release-neam: export version=0.7.0
release-neam: neam.dna-project-base
	echo "Pushing neam images to Docker Hub..."
	docker push neam/debian-php:fpm-5.6.20-hhvm-3.13.1
	docker push neam/debian-php:fpm-5.6.20-hhvm-3.13.1-for-debian-php-nginx-stack
	docker push neam/php-app-builder:$(version)
	docker push neam/php-app-worker:$(version)
	docker push neam/dna-project-base-debian-php:$(version)
	docker push neam/dna-project-base-debian-php-tester:$(version)
	docker push neam/debian-php:fpm-7.0.7-hhvm-3.13.1
	docker push neam/debian-php:fpm-7.0.7-hhvm-3.13.1-for-debian-php-nginx-stack
	docker push neam/php-app-builder:$(version)-php7.0
	docker push neam/php-app-worker:$(version)-php7.0
	docker push neam/dna-project-base-debian-php:$(version)-php7.0
	docker push neam/dna-project-base-debian-php-tester:$(version)-php7.0
	docker push neam/api-mock
