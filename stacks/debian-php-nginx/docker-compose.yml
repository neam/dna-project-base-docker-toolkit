# Docker compose configuration for local development

# The nginx server for serving static files directly, cached contents via the memcached server and php files via the php service
web:
  image: nginx:1.7
  links:
    - phphaproxy
    - phpfiles
  volumes:
    - .:/app:rw
  ports:
    - "80"
    - "443"
  environment:
    NGINX_ERROR_LOG_LEVEL: 'notice'
  working_dir: '/app'
  command: "/app/stack/nginx/run.sh"

# HA Proxy for php service scaling
phphaproxy:
  image: tutum/haproxy
  links:
    - phpha
  environment:
    BACKEND_PORT: 9000
    FRONTEND_PORT: 9000
    MODE: tcp

# The highly available php service for interpreting php code without access to /files
phpha:
  image: neam/debian-php:5.6.7-fpm
  links:
    - mailcatcher
    - redisphpsessionhandler
  volumes:
    - .:/app:rw
  ports:
    - "9000"
  environment:
    DISPLAY_PHP_ERRORS: 'on'
    RUNNING_LOCALLY: '1'
  env_file:
    - .env
  working_dir: '/app'
  command: "/app/stack/php/run.sh"

redisphpsessionhandler:
  image: redis

# The single-node php service for interpreting php code with read-write access to user-generated files
# (to support file uploads and other local file manipulations)
phpfiles:
  image: neam/debian-php:5.6.7-fpm
  links:
    - mailcatcher
    - redisphpsessionhandler
  volumes:
    - .:/app:rw
    - .files:/files:rw
  ports:
    - "9000"
  environment:
    DISPLAY_PHP_ERRORS: 'on'
    RUNNING_LOCALLY: '1'
  env_file:
    - .env
  working_dir: '/app'
  command: "/app/stack/php/run.sh"

# Mailcatcher server for catching outgoing email when not in production
mailcatcher:
  image: nisenabe/mailcatcher
  ports:
    - "25"
    - "1080"

# A container to run builder commands locally
builder:
  #build: vendor/neam/docker-stack/base-images/php-app-builder/
  image: neam/php-app-builder:0.2.0
  volumes:
    - .:/app:rw
    - .files:/files:rw
    - ../set-deployment-target.inc.sh:/set-deployment-target.inc.sh
    - ../.git:/.git
    - ~/.composer:/root/.composer
    - ~/.ssh:/root/.ssh:ro
  working_dir: '/app'
  command: "true"

# A container to run tester commands locally
tester:
  #build: vendor/neam/docker-stack/base-images/php-app-tester/
  image: neam/php-app-tester:0.2.0
  links:
    - web
  volumes:
    - .:/app:rw
    - .files:/files:rw
  working_dir: '/app'
  command: "true"

# A container to run worker/administration commands locally
worker:
  #build: vendor/neam/docker-stack/base-images/php-app-worker/
  image: neam/php-app-worker:0.2.0
  volumes:
    - .:/app:rw
    - .files:/files:rw
  working_dir: '/app'
  command: "true"

# A container that is linked to and thus can output linked information about running containers locally
info:
  image: debian:jessie
  volumes:
    - .:/app:rw
    - .files:/files:rw
  links:
    - web
    - phphaproxy
    - phpha
    - phpfiles
    - builder
    - tester
    - worker
  working_dir: '/app'
  command: "true"
